<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swagger UI + WebSocket Notifications</title>

    <link rel="stylesheet" href="/swagger-ui/swagger-ui.css"/>

    <!-- WebSocket libs -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        html { box-sizing: border-box; overflow-y: scroll; }
        *, *:before, *:after { box-sizing: inherit; }
        body { margin:0; background:#fafafa; }

        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            z-index: 99999;
        }

        .notification-popup {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            animation: slideIn .4s ease forwards;
            opacity: 0;
        }

        .notification-popup img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }
    </style>
</head>
<body>

<div id="swagger-ui"></div>
<div id="notification-container"></div>

<!-- Swagger scripts MUST be before usage -->
<script src="/swagger-ui/swagger-ui-bundle.js"></script>
<script src="/swagger-ui/swagger-ui-standalone-preset.js"></script>

<script>
    window.addEventListener("load", () => {

        /* ---------------- Token ---------------- */
        const hash = location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get("token");

        /* ---------------- Swagger ---------------- */
        if (typeof SwaggerUIBundle === "undefined") {
            console.error("SwaggerUIBundle not loaded");
            return;
        }

        SwaggerUIBundle({
            url: "/v3/api-docs",
            dom_id: "#swagger-ui",
            presets: [
                SwaggerUIBundle.presets.apis,
                SwaggerUIStandalonePreset
            ],
            layout: "StandaloneLayout",
            requestInterceptor: req => {
                if (token) {
                    req.headers.Authorization = "Bearer " + token;
                }
                return req;
            }
        });

        /* ---------------- Notifications ---------------- */
        function showNotification(n) {
            const c = document.getElementById("notification-container");
            const p = document.createElement("div");
            p.className = "notification-popup";

            p.innerHTML = `
            <img src="${n.pfpurl || '/default-avatar.png'}">
            <div>
                <div><strong>${n.message}</strong></div>
                <div style="font-size:12px;color:#666">Tap to view</div>
            </div>
        `;

            c.appendChild(p);

            setTimeout(() => {
                p.style.animation = "fadeOut .4s forwards";
                setTimeout(() => p.remove(), 400);
            }, 5000);
        }

        if (token) {
            const socket = new SockJS("/ws");
            const stomp = Stomp.over(socket);

            /* Enable logging to see sent messages */
            stomp.debug = msg => console.log("[STOMP]", msg);

            stomp.connect(
                { Authorization: "Bearer " + token },
                () => {
                    console.log("STOMP connected");

                    // Subscribe to notifications
                    stomp.subscribe("/user/queue/notifications", msg => {
                        try {
                            showNotification(JSON.parse(msg.body));
                        } catch {
                            showNotification({ message: msg.body });
                        }
                    });

                    // Send heartbeat every 10 seconds
                    setInterval(() => {
                        if (stomp.connected) {
                            console.log("Sending heartbeat...");
                            stomp.send("/app/heartbeat", {}, "ping");
                        }
                    }, 10000);
                },
                err => console.error("WS error", err)
            );

            // Clean URL
            history.replaceState(null, null, location.pathname);
        }
    });
</script>

</body>
</html>
